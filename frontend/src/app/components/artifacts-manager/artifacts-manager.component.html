<div class="artifacts-container">
  
  <!-- Lista de Artefactos (siempre visible) -->
  <div class="artifacts-list">
    <div class="artifacts-header">
      <h3>
        <span class="icon">üì¶</span> Artefactos
      </h3>
      <button 
        *ngIf="canCreate"
        class="btn btn-outline-primary btn-sm add-btn" 
        type="button" 
        data-bs-toggle="collapse" 
        [attr.data-bs-target]="'#form' + phaseId" 
        aria-expanded="false">
        <i class="fas fa-plus"></i>
      </button>
    </div>

    <!-- Lista de artefactos existentes -->
    <div *ngIf="artifacts.length === 0" class="no-artifacts">
      <p>No hay artefactos registrados</p>
    </div>
    
    <div *ngFor="let artifact of artifacts" class="artifact-item">
      <div class="artifact-info">
        <span class="artifact-type">{{ artifact.typeName }}</span>
        
        <!-- HU-012: Mostrar estado de Workflow si existe -->
        <span *ngIf="artifact.workflowName" class="badge bg-info text-dark ms-1">
          <i class="fas fa-project-diagram"></i> {{ artifact.workflowName }}: {{ artifact.currentStepName }}
        </span>

        <span *ngIf="!artifact.workflowName" class="badge artifact-status" [ngClass]="getStatusClass(artifact.status)">
          {{ artifact.statusName }}
        </span>

        <small *ngIf="artifact.assignedTo" class="text-muted ms-2">
          <i class="fas fa-user"></i> {{ artifact.assignedTo }}
        </small>
        <a *ngIf="artifact.versions && artifact.versions[0]?.repositoryUrl" [href]="artifact.versions[0]!.repositoryUrl" target="_blank" class="ms-2 text-decoration-none">
          <i class="fab fa-github"></i> Repo
        </a>
      </div>
      <div class="artifact-actions mt-1">
        <!-- Acciones Est√°ndar -->
        <ng-container *ngIf="!artifact.workflowName">
          <!-- Enviar a Revisi√≥n: Solo quien puede editar (Autor, Desarrollador, Admin, PO, SM) -->
          <button *ngIf="artifact.statusName === 'Pending' && canEdit" class="btn btn-xs btn-outline-info me-1" (click)="updateArtifactStatus(artifact, 'InReview')">
            Enviar a Revisi√≥n
          </button>
          <!-- Aprobar: Solo quien puede aprobar (Revisor, PO, SM, Admin) -->
          <button *ngIf="artifact.statusName === 'InReview' && canApprove" class="btn btn-xs btn-outline-success me-1" (click)="updateArtifactStatus(artifact, 'Approved')">
            Aprobar
          </button>
          <!-- Rechazar: Solo quien puede aprobar -->
          <button *ngIf="artifact.statusName === 'InReview' && canApprove" class="btn btn-xs btn-outline-danger me-1" (click)="updateArtifactStatus(artifact, 'Pending')">
            Rechazar
          </button>
        </ng-container>

        <!-- HU-012: Acciones de Workflow -->
        <ng-container *ngIf="artifact.workflowName">
          <button *ngIf="canEdit || canApprove" class="btn btn-xs btn-outline-primary me-1" (click)="advanceWorkflowStep(artifact)">
            Avanzar Paso <i class="fas fa-forward"></i>
          </button>
        </ng-container>

        <!-- Agregar versi√≥n: Solo quien puede editar -->
        <button *ngIf="canEdit" class="btn btn-xs btn-outline-secondary" (click)="openVersionForm(artifact.id)">
          + Versi√≥n
        </button>
      </div>
      <small class="text-muted">{{ artifact.isMandatory ? 'Obligatorio' : 'Opcional' }}</small>
      
      <!-- Formulario de Nueva Versi√≥n (Inline) -->
      <div *ngIf="selectedArtifactIdForVersion === artifact.id" class="mt-2 p-2 border rounded bg-light">
        <h6>Nueva Versi√≥n</h6>
        <form [formGroup]="versionForm" (ngSubmit)="onSubmitVersion()">
          <div class="mb-2">
            <input type="text" class="form-control form-control-sm" placeholder="Autor *" formControlName="author">
          </div>
          <div class="mb-2">
            <textarea class="form-control form-control-sm" placeholder="Descripci√≥n de cambios" formControlName="content"></textarea>
          </div>
          <div class="mb-2">
            <input type="url" class="form-control form-control-sm" placeholder="URL Repositorio" formControlName="repositoryUrl">
          </div>
          <div class="mb-2">
            <input type="file" class="form-control form-control-sm" (change)="onVersionFileSelected($event)">
          </div>
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-sm btn-primary" [disabled]="versionForm.invalid">Subir</button>
            <button type="button" class="btn btn-sm btn-secondary" (click)="cancelVersionForm()">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Formulario colapsable (solo aparece al hacer clic en +) -->
  <div class="collapse" [id]="'form' + phaseId">
    <div class="form-container">
      <div class="form-header">
        <h6>Nuevo Artefacto</h6>
      </div>
      <form [formGroup]="artifactForm" (ngSubmit)="onSubmit()">
        <div class="row">
          <div class="col-12 mb-3">
            <label for="type" class="form-label">Tipo</label>
            <select id="type" class="form-select form-select-sm" formControlName="type">
              <option [ngValue]="null" disabled>Seleccione...</option>
              <option *ngFor="let type of artifactTypes" [ngValue]="type.value">
                {{ type.key }}
              </option>
            </select>
          </div>
          <div class="col-12 mb-3">
            <label for="author" class="form-label">Autor</label>
            <input type="text" id="author" class="form-control form-control-sm" formControlName="author">
          </div>
          <div class="col-12 mb-3">
            <label for="assignedTo" class="form-label">Asignado A (Responsable)</label>
            <input type="text" id="assignedTo" class="form-control form-control-sm" formControlName="assignedTo">
          </div>
        </div>
        <div class="mb-3">
          <label for="content" class="form-label">Contenido (Opcional)</label>
          <textarea id="content" class="form-control form-control-sm" rows="2" formControlName="content"></textarea>
        </div>
        <div class="mb-3">
          <label for="repositoryUrl" class="form-label">URL del Repositorio (Opcional)</label>
          <input type="url" id="repositoryUrl" class="form-control form-control-sm" formControlName="repositoryUrl" placeholder="https://github.com/...">
        </div>
        <div class="row">
          <div class="col-6 mb-3">
            <label for="buildIdentifier" class="form-label">ID de Build / Versi√≥n (Opcional)</label>
            <input type="text" id="buildIdentifier" class="form-control form-control-sm" formControlName="buildIdentifier" placeholder="v1.0.0-beta">
          </div>
          <div class="col-6 mb-3">
            <label for="buildDownloadUrl" class="form-label">URL de Descarga (Opcional)</label>
            <input type="url" id="buildDownloadUrl" class="form-control form-control-sm" formControlName="buildDownloadUrl" placeholder="https://...">
          </div>
        </div>
        <div class="mb-3">
          <label for="fileInput" class="form-label">Archivo (Opcional)</label>
          <input type="file" id="fileInput" class="form-control form-control-sm" (change)="onFileSelected($event)">
        </div>

        <!-- CORRECCI√ìN AQU√ç: Usamos formControlName en lugar de ngModel -->
        <!-- Solo PO y Admin pueden marcar como obligatorio -->
        <div class="form-group mt-3" *ngIf="canSetRequired">
          <div class="form-check form-switch">
            <input 
                class="form-check-input" 
                type="checkbox" 
                id="mandatorySwitch"
                formControlName="isMandatory"> 
            <label class="form-check-label" for="mandatorySwitch">
                {{ artifactForm.get('isMandatory')?.value ? '‚ö†Ô∏è Obligatorio' : 'üîì Opcional' }}
            </label>
          </div>
          <small class="text-muted">
              Si es obligatorio, no se podr√° avanzar de fase hasta que este artefacto est√© entregado.
          </small>
        </div>

        <!-- HU-012: Selecci√≥n de Workflow -->
        <div class="col-12 mb-3">
          <label for="workflow" class="form-label">Flujo de Trabajo (Opcional)</label>
          <select id="workflow" class="form-select form-select-sm" formControlName="workflowId">
            <option [ngValue]="null">Ninguno (Est√°ndar)</option>
            <option *ngFor="let wf of workflows" [ngValue]="wf.id">
              {{ wf.name }}
            </option>
          </select>
          <small class="form-text text-muted" *ngIf="!artifactForm.get('workflowId')?.value">
            El artefacto seguir√° el flujo de estados est√°ndar: Pendiente ‚Üí En Revisi√≥n ‚Üí Aprobado
          </small>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary btn-sm" [disabled]="artifactForm.invalid">
            Guardar
          </button>
          <button 
            type="button" 
            class="btn btn-secondary btn-sm" 
            data-bs-toggle="collapse" 
            [attr.data-bs-target]="'#form' + phaseId">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>