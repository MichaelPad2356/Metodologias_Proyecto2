@if (!loading && !error && project) {
  <div class="project-detail-container">
    <header class="page-header">
      <div>
        <a routerLink="/projects" class="back-link">‚Üê Volver a proyectos</a>
        <h1>{{ project.name }}</h1>
        <span class="project-code">{{ project.code }}</span>
      </div>
      <div class="header-actions">
        <button class="btn btn-primary" [routerLink]="['/planning', project.id]">
          üìä Gestionar Iteraciones
        </button>
        <span class="status-badge" [ngClass]="getStatusClass(project.status)">
          {{ getStatusLabel(project.status) }}
        </span>
      </div>
    </header>
    <div class="content-grid">
      <!-- Informaci√≥n del proyecto -->
      <div class="card project-info-card">
        <h2>Informaci√≥n del Proyecto</h2>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Responsable:</span>
            <span>{{ project.responsiblePerson || 'No asignado' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Fecha de inicio:</span>
            <span>{{ project.startDate | date:'dd/MM/yyyy' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Fecha de creaci√≥n:</span>
            <span>{{ project.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>
          @if (project.archivedAt) {
            <div class="info-item">
              <span class="info-label">Fecha de archivo:</span>
              <span>{{ project.archivedAt | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>
          }
          @if (project.tags) {
            <div class="info-item">
              <span class="info-label">Etiquetas:</span>
              <span class="tags">{{ project.tags }}</span>
            </div>
          }
        </div>
        @if (project.description) {
          <div class="info-description">
            <h3>Descripci√≥n</h3>
            <p>{{ project.description }}</p>
          </div>
        }
      </div>

      <!-- Progreso del Proyecto -->
      <app-project-progress [projectId]="project.id"></app-project-progress>

      <!-- Plan del Proyecto -->
      <div class="card plan-card">
        <div class="plan-header">
          <h2>üìã Plan del Proyecto</h2>
          <div class="plan-actions">
            <button class="btn btn-sm btn-primary" (click)="openSaveVersionModal()" title="Guardar versi√≥n del plan">
              üíæ Guardar Versi√≥n
            </button>
            <button class="btn btn-sm btn-secondary" (click)="openVersionsModal()" title="Ver historial de versiones">
              üìú Historial
            </button>
            <button class="btn btn-sm btn-secondary" (click)="exportToPDF()" title="Exportar a PDF">
              üìÑ Exportar PDF
            </button>
          </div>
        </div>
        
        @if (project.objetivos || project.alcance || project.cronogramaInicial || project.responsables || project.hitos) {
          <div class="plan-content">
            @if (project.objetivos) {
              <div class="plan-section">
                <h3>üéØ Objetivos</h3>
                <p class="plan-text">{{ project.objetivos }}</p>
              </div>
            }

            @if (project.alcance) {
              <div class="plan-section">
                <h3>üìê Alcance</h3>
                <p class="plan-text">{{ project.alcance }}</p>
              </div>
            }

            @if (project.cronogramaInicial) {
              <div class="plan-section">
                <h3>üìÖ Cronograma Inicial</h3>
                <div class="cronograma-list">
                  @for (item of parseCronograma(project.cronogramaInicial); track $index) {
                    <div class="cronograma-item-display">
                      <span class="cronograma-date">{{ item.date | date:'dd/MM/yyyy' }}</span>
                      <span class="cronograma-desc">{{ item.description }}</span>
                    </div>
                  }
                </div>
              </div>
            }

            @if (project.responsables) {
              <div class="plan-section">
                <h3>üë• Responsables</h3>
                <ul class="responsables-list">
                  @for (resp of parseResponsables(project.responsables); track $index) {
                    <li>{{ resp }}</li>
                  }
                </ul>
              </div>
            }

            @if (project.hitos) {
              <div class="plan-section">
                <h3>üèÅ Hitos</h3>
                <ol class="hitos-list">
                  @for (hito of parseHitos(project.hitos); track $index) {
                    <li>{{ hito }}</li>
                  }
                </ol>
              </div>
            }
          </div>
        } @else {
          <p class="empty-state">No se ha definido un plan para este proyecto.</p>
        }
      </div>

      <!-- Fases de OpenUP -->
      <div class="card phases-card">
        <h2>Fases de OpenUP</h2>
        <div class="phases-list">
          @for (phase of project.phases; track phase) {
            <div class="phase-item-container">
              <div
                class="phase-item"
                [ngClass]="getPhaseStatusClass(phase.status)"
                >
                <div class="phase-number">{{ phase.order }}</div>
                <div class="phase-info">
                  <h3>{{ phase.name }}</h3>
                  <span class="phase-status">
                    {{ getPhaseStatusLabel(phase.status) }}
                  </span>
                </div>
                <div class="phase-actions ms-auto">
                  @if (phase.status === 'NotStarted') {
                    <button class="btn btn-sm btn-success" (click)="updatePhaseStatus(phase, 'InProgress')">
                      ‚ñ∂ Iniciar
                    </button>
                  }
                  @if (phase.status === 'InProgress') {
                    <button class="btn btn-sm btn-primary" (click)="updatePhaseStatus(phase, 'Completed')">
                      ‚úÖ Completar
                    </button>
                  }
                </div>
              </div>
              <!-- ARTEFACTOS PARA ESTA FASE -->
              <div class="artifacts-for-phase">
                @if (phase.name === 'Transici√≥n') {
                  <!-- Bot√≥n especial para fase de Transici√≥n (HU-009) -->
                  <div class="transition-phase-card">
                    <div class="transition-info">
                      <h4>üìã Artefactos de Cierre</h4>
                      <p>Gestiona los documentos de entrega: Manual de Usuario, Manual T√©cnico, Plan de Despliegue, Build Final, Pruebas Beta y Documento de Cierre.</p>
                    </div>
                    <button class="btn btn-primary btn-transition" [routerLink]="['/projects', project.id, 'transition']">
                      üöÄ Gestionar Artefactos de Transici√≥n
                    </button>
                  </div>
                } @else {
                  <app-artifacts-manager [phaseId]="phase.id"></app-artifacts-manager>
                }
              </div>
            </div>
          }
        </div>
      </div>
    </div>
    <!-- Acciones -->
    @if (project.status !== 'Archived') {
      <div class="actions-bar">
        <button class="btn btn-secondary" (click)="confirmArchive()">
          üì¶ Archivar Proyecto
        </button>
        @if (canDelete) {
          <button class="btn btn-danger" (click)="confirmDelete()">
            üóëÔ∏è Eliminar Permanentemente
          </button>
        }
      </div>
    }
    @if (project.status === 'Archived') {
      <div class="actions-bar">
        <button class="btn btn-primary" (click)="confirmUnarchive()">
          üì§ Desarchivar Proyecto
        </button>
        @if (canDelete) {
          <button class="btn btn-danger" (click)="confirmDelete()">
            üóëÔ∏è Eliminar Permanentemente
          </button>
        }
      </div>
    }
  </div>
}

<!-- Modal para guardar nueva versi√≥n del plan -->
@if (showSaveVersionModal) {
  <div class="modal-overlay" (click)="closeSaveVersionModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>üíæ Guardar Nueva Versi√≥n del Plan</h2>
        <button class="modal-close" (click)="closeSaveVersionModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <p>Se guardar√° una nueva versi√≥n del plan actual con la siguiente informaci√≥n:</p>
        <ul>
          <li>Objetivos</li>
          <li>Alcance</li>
          <li>Cronograma inicial</li>
          <li>Responsables</li>
          <li>Hitos</li>
        </ul>
        <div class="form-group">
          <label for="observaciones">
            Observaciones <span class="required">*</span>
          </label>
          <textarea
            id="observaciones"
            name="observaciones"
            [(ngModel)]="versionObservaciones"
            rows="4"
            placeholder="Describa los cambios o motivo de esta nueva versi√≥n..."
            [disabled]="savingVersion"
            maxlength="500"
          ></textarea>
          <small class="form-hint">M√°ximo 500 caracteres</small>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeSaveVersionModal()" [disabled]="savingVersion">
          Cancelar
        </button>
        <button class="btn btn-primary" (click)="saveNewVersion()" [disabled]="savingVersion || !versionObservaciones.trim()">
          {{ savingVersion ? 'Guardando...' : 'Guardar Versi√≥n' }}
        </button>
      </div>
    </div>
  </div>
}

<!-- Modal para ver historial de versiones -->
@if (showVersionsModal) {
  <div class="modal-overlay" (click)="closeVersionsModal()">
    <div class="modal-content modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>üìú Historial de Versiones del Plan</h2>
        <button class="modal-close" (click)="closeVersionsModal()">‚úï</button>
      </div>
      <div class="modal-body">
        @if (planVersions.length === 0) {
          <p class="empty-state">No hay versiones guardadas del plan.</p>
        } @else {
          @if (!selectedVersion) {
            <div class="versions-list">
              @for (version of planVersions; track version.id) {
                <div class="version-item" (click)="viewVersion(version)">
                  <div class="version-header">
                    <h3>Versi√≥n {{ version.version }}</h3>
                    <span class="version-date">{{ version.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
                  </div>
                  <p class="version-obs">{{ version.observaciones }}</p>
                  @if (version.createdBy) {
                    <small class="version-author">Creado por: {{ version.createdBy }}</small>
                  }
                </div>
              }
            </div>
          } @else {
            <div class="version-detail">
              <button class="btn btn-sm btn-secondary" (click)="closeVersionDetail()">‚Üê Volver</button>
              <h3>Versi√≥n {{ selectedVersion.version }}</h3>
              <p><strong>Fecha:</strong> {{ selectedVersion.createdAt | date:'dd/MM/yyyy HH:mm' }}</p>
              @if (selectedVersion.createdBy) {
                <p><strong>Creado por:</strong> {{ selectedVersion.createdBy }}</p>
              }
              <p><strong>Observaciones:</strong> {{ selectedVersion.observaciones }}</p>
              
              <div class="version-plan-content">
                @if (selectedVersion.objetivos) {
                  <div class="plan-section">
                    <h4>üéØ Objetivos</h4>
                    <p>{{ selectedVersion.objetivos }}</p>
                  </div>
                }
                @if (selectedVersion.alcance) {
                  <div class="plan-section">
                    <h4>üìê Alcance</h4>
                    <p>{{ selectedVersion.alcance }}</p>
                  </div>
                }
                @if (selectedVersion.cronogramaInicial) {
                  <div class="plan-section">
                    <h4>üìÖ Cronograma Inicial</h4>
                    <pre>{{ selectedVersion.cronogramaInicial }}</pre>
                  </div>
                }
                @if (selectedVersion.responsables) {
                  <div class="plan-section">
                    <h4>üë• Responsables</h4>
                    <pre>{{ selectedVersion.responsables }}</pre>
                  </div>
                }
                @if (selectedVersion.hitos) {
                  <div class="plan-section">
                    <h4>üèÅ Hitos</h4>
                    <pre>{{ selectedVersion.hitos }}</pre>
                  </div>
                }
              </div>
            </div>
          }
        }
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeVersionsModal()">
          Cerrar
        </button>
      </div>
    </div>
  </div>
}

@if (loading) {
  <div class="loading">
    <p>Cargando proyecto...</p>
  </div>
}

@if (error) {
  <div class="error-container">
    <div class="error-message">
      <h2>Error</h2>
      <p>{{ error }}</p>
      <a routerLink="/projects" class="btn btn-primary">Volver a proyectos</a>
    </div>
  </div>
}
